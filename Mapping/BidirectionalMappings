install.packages("tidyverse") # includes ggplot2??
install.packages("ggplot2") # for general plots
install.packages("beeswarm") # for beeswarm plots
install.packages("colorspace") # for fixing colors in plots
install.packages("stargazer") # for pretty regression output tables
install.packages("MASS") # for polr package
install.packages("generalhoslem") # for testing model fit (lipsitz test and two others)
install.packages("qwraps2") # for summary_table use
install.packages("quantreg") # testing quantile plots (geom_quantile) and quantile regressions
install.packages("sure") # package for calculating residuals for ordinal logistic regression (https://journal.r-project.org/archive/2018/RJ-2018-004/RJ-2018-004.pdf)
install.packages("mediation") # package for testing mediation effects
install.packages("gridExtra") # combine graphs into one figure 
install.packages("plyr")
install.packages("reshape2") #restructuring dataframes, ex melting, merging 
install.packages("plotrix")



library(tidyverse) 
library(ggplot2)
library(beeswarm)
library(colorspace) 
library(stargazer)
library(MASS)
library(generalhoslem) 
library(qwraps2) 
library(quantreg) 
library(sure) 
library(mediation) 
library(gridExtra)
library(plyr)
library(reshape2)
library(plotrix)

setwd("/Users/labuser/Documents/R")
getwd()

#LAPTOP setwd("~/Desktop")

Mapping <- read.csv("Mapping_Coding_CH_190809.csv", na.strings = "N/A")
 
typeof(Mapping) # when importing using read.csv, resulting obj type is a list (data frame)
View(Mapping)

####HEARING KIDS ONLY####

Map_HBE <- subset(Mapping, Mapping$Including.in.Study == 'Yes' & Mapping$Coded. == "Yes" & Mapping$Group_2cat == 'Hearing')
View(Map_HBE)
str(Map_HBE)

## MEDIAN AND SD FOR EACH MAPPING TYPE #
median(Map_HBE$SumTotal_QuantityWord)
sd(Map_HBE$SumTotal_QuantityWord, na.rm = TRUE)
median(Map_HBE$SumTotal_WordQuantity)
sd(Map_HBE$SumTotal_WordQuantity, na.rm = TRUE)
median(Map_HBE$SumTotal_QuantityNumeral)
sd(Map_HBE$SumTotal_QuantityNumeral, na.rm = TRUE)
median(Map_HBE$SumTotal_NumeralQuantity)
sd(Map_HBE$SumTotal_NumeralQuantity, na.rm = TRUE)
median(Map_HBE$SumTotal_WordNumeral)
sd(Map_HBE$SumTotal_WordNumeral, na.rm = TRUE)
median(Map_HBE$SumTotal_NumeralWord)
sd(Map_HBE$SumTotal_NumeralWord, na.rm = TRUE)

## ASYMMETRIES? ## 
  #QUANTITY-WORD#
      QW<-wilcox.test(Map_HBE$SumTotal_QuantityWord, Map_HBE$SumTotal_WordQuantity, paired = TRUE, exact=FALSE)
      QW
      QW_Zstat<-qnorm(QW$p.value/2)
      QW_Zstat
      abs(QW_Zstat)/sqrt(17)
      
  #QUANTITY-NUMERAL#
      QN<-wilcox.test(Map_HBE$SumTotal_QuantityNumeral, Map_HBE$SumTotal_NumeralQuantity, paired = TRUE, exact=FALSE)
      QN
      QN_Zstat<-qnorm(QN$p.value/2)
      QN_Zstat
      abs(QN_Zstat)/sqrt(17)
      
  #WORD-NUMERAL#
      WN<-wilcox.test(Map_HBE$SumTotal_WordNumeral, Map_HBE$SumTotal_NumeralWord, paired = TRUE, exact=FALSE)
      WN
      WN_Zstat<-qnorm(WN$p.value/2)
      WN_Zstat
      abs(WN_Zstat)/sqrt(17)
      
 
 ## HISTOGRAM OF DIFFERENCE SCORES FOR MAPPING PAIRS ##
     #Want columns to start at x axis, but solutions all include changing expand to start at 0. that would remove the blank columns.#
         DH_QW <- ggplot(Map_HBE, aes(x=Map_HBE$Difference_Quantity.Word_Word.Quantity)) + geom_bar(aes(y=..count../sum(..count..))) + labs(y="Proportion of Children", x="Quantity-Word > Word-Quantity") + theme(panel.background = element_blank(), text = element_text(size=12, family="Times New Roman")) + expand_limits(x = c(-8,9), y = c(0,1)) + scale_y_continuous(breaks = c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1)) + scale_x_continuous(breaks=c(-8,-7,-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9)) + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.line = element_line(colour = "black")) 
         DH_QW

         DH_NW <- ggplot(Map_HBE, aes(x=Map_HBE$Difference_Numeral.Word_Word.Numeral)) + geom_bar(aes(y=..count../sum(..count..))) + labs(x="Numeral-Word > Word-Numeral") + theme(panel.background = element_blank(), axis.title.y=element_blank(), text = element_text(size=12, family="Times New Roman")) + expand_limits(x = c(-8,9), y = c(0,1)) + scale_y_continuous(breaks = c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1)) + scale_x_continuous(breaks=c(-8,-7,-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9)) + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.line = element_line(colour = "black")) 
         DH_NW 

         DH_QN <- ggplot(Map_HBE, aes(x=Map_HBE$Difference_Quantity.Numeral_Numeral.Quantity)) + geom_bar(aes(y=..count../sum(..count..))) + labs(x="Quantity-Numeral > Numeral-Quantity")+ theme(panel.background = element_blank(), axis.title.y=element_blank(), text = element_text(size=12, family="Times New Roman")) + expand_limits(x = c(-8,9), y = c(0,1)) + scale_y_continuous(breaks = c(0,0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1)) + scale_x_continuous(breaks=c(-8,-7,-6,-5,-4,-3,-2,-1,0,1,2,3,4,5,6,7,8,9)) + theme(panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(),axis.line = element_line(colour = "black")) 
         DH_QN

         grid.arrange(DH_QW, DH_NW, DH_QN, ncol = 3) 
         
     #SKEWNESS, KURTOSIS, MEAN,RANGE,SD,SE#
         install.packages(“psych”)
         library(psych)
         describe(Map_HBE$Difference_Quantity.Numeral_Numeral.Quantity)
         describe(Map_HBE$Difference_Quantity.Word_Word.Quantity)
         describe(Map_HBE$Difference_Numeral.Word_Word.Numeral)
         
         
     #PERCENT THAT FALLS BETWEEN 1 POINT#
         DiffQW <- Map_HBE$Difference_Quantity.Word_Word.Quantity
         QW_1 <- length(which(DiffQW >= 0 & DiffQW <= 2)) #number of observations that fall 1 point above or below DiffQW median of 1
         N <- nrow(Map_HBE) #gives # of observations
         (QW_1/N)*100

         DiffNW <- Map_HBE$Difference_Numeral.Word_Word.Numeral
         NW_1 <- length(which(DiffNW >= 0 & DiffNW <= 2)) #number of observations that fall 1 point above or below DiffNW median of 1
         N <- nrow(Map_HBE) #gives # of observations
         (NW_1/N)*100

         DiffQN <- Map_HBE$Difference_Quantity.Numeral_Numeral.Quantity
         QN_1 <- length(which(DiffQN >= 1 & DiffQN <= 3)) #number of observations that fall 1 point above or below DiffQN median of 2
         N <- nrow(Map_HBE) #gives # of observations
         (QN_1/N)*100



 ## IF SEPARATING BY AGE GROUPS ##
Map_HBE$AgeGrp <- ifelse(Map_HBE$Age_Rounded < 6, "5-year-olds", "6 and up")
Map5 <- subset(Map_HBE, Map_HBE$AgeGrp =="5-year-olds")
Map6up <- subset(Map_HBE, Map_HBE$AgeGrp =="6 and up")

 #GRAPH OF ACCURACY SCORES BY MAPPING PAIRS AND AGE#
      #INDIV GRAPHS#
      QW_Bar <- ggplot(data=Map_HBE, aes(x=Map_HBE$AgeGrp, y=Map_HBE$Sum_Quantity.Word_Word.Quantity, fill=Map_HBE$AgeGrp)) + geom_bar(stat="identity", position=position_dodge(), colour="black") + scale_fill_manual(values=c("black", "grey66")) + labs(x="Quantity-Word", y="Accuracy (out of 17)") + theme(text = element_text(size=12, family="Times New Roman")) + expand_limits(y = c(0,17)) + scale_y_continuous (breaks=c(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17))
      QW_Bar

      NW_Bar <- ggplot(data=Map_HBE, aes(x=Map_HBE$AgeGrp, y=Map_HBE$Sum_Numeral.Word_Word.Numeral, fill=Map_HBE$AgeGrp)) + geom_bar(stat="identity", position=position_dodge(), colour="black") + scale_fill_manual(values=c("black", "grey66")) + labs(x="Numeral-Word", y="Accuracy (out of 17)") + theme(text = element_text(size=12, family="Times New Roman")) + expand_limits(y = c(0,17)) + scale_y_continuous (breaks=c(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17))
      NW_Bar

      QN_Bar <- ggplot(data=Map_HBE, aes(x=Map_HBE$AgeGrp, y=Map_HBE$Sum_Quantity.Numeral_Numeral.Quantity, fill=Map_HBE$AgeGrp)) + geom_bar(stat="identity", position=position_dodge(), colour="black") + scale_fill_manual(values=c("black", "grey66")) + labs(x="Quantity-Numeral", y="Accuracy (out of 17)") + theme(text = element_text(size=12, family="Times New Roman")) + expand_limits(y = c(0,17)) + scale_y_continuous (breaks=c(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17))
      QN_Bar 

##GROUPED BAR PLOT##
      ##SOURCE: https://onunicornsandgenes.blog/2014/03/19/using-r-barplot-with-ggplot2/##
      
      ## 1. SET SHORT VARIABLE NAMES ##
       NW <- Map_HBE$Sum_Numeral.Word_Word.Numeral
       QW <- Map_HBE$Sum_Quantity.Word_Word.Quantity
       QN <- Map_HBE$Sum_Quantity.Numeral_Numeral.Quantity
       AgeGrp <- Map_HBE$AgeGrp
       QW_M <- mean(Map_HBE$Sum_Quantity.Word_Word.Quantity)
       NW_M <- mean(Map_HBE$Sum_Numeral.Word_Word.Numeral)
       QN_M <- mean(Map_HBE$Sum_Quantity.Numeral_Numeral.Quantity)


      ## 2. CREATE FIRST DATA FRAME WITH MAPPING TYPES## 
       df <- data.frame(AgeGrp, QW, NW, QN)
       View(df)
       data.m <- melt(df, id.vars='AgeGrp') #melt the dataframe so all the mapping types are in the same column
       View(data.m)
       ## 3. CREATE SECOND DATA FRAME ## 
       dfM <- data.frame(AgeGrp, QW_M, NW_M, QN_M)
       View(dfM)
       dfM2 <- melt(dfM, id.vars='AgeGrp')
       View(dfM2)

      ## 4. RENAME VARIABLE COLUMN IN FIRST DATA FRAME TO MAP & CREATE SHORTCUT VARIABLE ##
       names(data.m)[names(data.m) == "variable"] <- "Map"
       View(data.m)

      # 5. ADD MAP COLUMN TO THE OTHER DATA FRAME ##
       dfM2 <- data.frame(AgeGrp, dfM2$variable, dfM2$value, data.m$Map)
       names(dfM2)[names(dfM2) == "data.m.Map"] <- "Map"
       View(dfM2)

      ## 6. CREATE NEW DATAFRAME WITH TWO DATA FRAMES & RENAME COLUMNS ##
       PWEASE <- data.frame(AgeGrp, data.m$Map, data.m$value, dfM2$dfM2.variable, dfM2$dfM2.value)
       names(PWEASE)[names(PWEASE) == "dfM2.dfM2.value"] <- "Map_Mean"
       names(PWEASE)[names(PWEASE) == "data.m.Map"] <- "Map"
       View(PWEASE)
      
      ## 7. CREATE THRID DATA FRAME WITH SEMS ##
          QW_SE <- std.error(Map_HBE$Sum_Quantity.Word_Word.Quantity)
          NW_SE <- std.error(Map_HBE$Sum_Numeral.Word_Word.Numeral)
          QN_SE <- std.error(Map_HBE$Sum_Quantity.Numeral_Numeral.Quantity)

          dSE <- data.frame(AgeGrp, QW_SE, NW_SE, QN_SE)
          dSE2 <- melt(dSE, id.vars='AgeGrp')
          View(dSE2)

          dSE2<- data.frame(AgeGrp, dSE2$variable, dSE2$value, PWEASE$Map)
          names(dSE2)[names(dSE2) == "PWEASE.Map"] <- "Map"
          names(dSE2)[names(dSE2) == "dSE2.value"] <- "SEM"
          View(dSE2)

      ## 8. MERGE PREVIOUSLY COMBINED DATAFRAME WITH SEM DATA FRAME ##
          PORFAVOR <- merge(PWEASE, dSE2)
          View(PORFAVOR)
      
      ## 9. ADD COLUMNS FOR ERROR BARS ##
       lower <- PORFAVOR$Map_Mean - PORFAVOR$SEM
       upper <- PORFAVOR$Map_Mean + PORFAVOR$SEM
       PORFAVOR <- cbind(PORFAVOR, lower, upper)
       View(PORFAVOR)
  
      ## 10. CREATE BAR PLOT AND ADD ERROR BARS ##
        All_Bar <- ggplot(PORFAVOR, aes(PORFAVOR$Map, PORFAVOR$Map_Mean)) + geom_bar(aes(fill = AgeGrp), width = 0.6, position = position_dodge(width=0.7), stat="identity") + scale_fill_manual(values=c("grey87", "grey51"), labels = c("5-year-olds", "6-year-olds and older")) + labs( y="Accuracy (out of 17)") + scale_y_continuous (breaks=c(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17), limits = c(0,17), expand = c(0,0)) + scale_x_discrete(limits=c("QW","NW","QN"), expand = c(.2,0),labels = c("Quantity and Word", "Numeral and Word", "Quantity and Numeral")) + theme_bw() + theme(legend.position="top", legend.title = element_blank(), axis.title.x=element_blank(), panel.border = element_blank(), panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), panel.grid.minor.y = element_blank(), axis.line = element_line(colour = "black"), text = element_text(size=12, family="Times New Roman"))
        All_Bar + geom_errorbar(aes(ymax= PORFAVOR$upper, ymin=PORFAVOR$lower, group=AgeGrp), width=.5, position=position_dodge(0.7), data=PORFAVOR)


## ANOVAS ##
     ## BEFORE RUN, HAVE DATA.M AS A DF FROM ABOVE CODE ##
     ## REMEMBER TYPE 2 IS FOR BETWEEN SUBJECTS ##
     
     replications(data.m) # CHECK BALANCE OF THE DATA TO ENSURE CAN USE AOV FXN. AOV can be used for balanced & unbalanced, but to a certain extent#

     ## AGE GROUP (2 LEVELS) --> SUM SCORES? One-way ANOVA unbalanced (different sample sizes), between subjects design ##
     aov_age<- aov(data.m$value ~ data.m$AgeGrp)
     summary(aov_age)
     tuk_age<- TukeyHSD(aov_age)
     tuk_age  #can see WHICH variables are significantly different#

     ## MAP PAIR (3 LEVELS) --> SUM SCORES? One-way ANOVA balanced, within subjects/repeated measures design ##
     aov_map<- aov(data.m$value ~ data.m$Map)
     summary(aov_map)
     tuk_map<- TukeyHSD(aov_map)
     tuk_map #can see WHICH variables are significantly different#

     ## INTERACTION BETWEEN INDEPENDENT VARIABLES? ##
     ## Source: https://rcompanion.org/handbook/G_09.html ##
     install.packages("car")
     library(car)
     model = lm(data.m$value ~ data.m$AgeGrp + data.m$Map + data.m$AgeGrp:data.m$Map, data = data.m)
     Anova(model, type = "II")
     
     ## ETA-SQUARED ##
     # SOURCE: https://cran.r-project.org/web/packages/lsr/lsr.pdf #
     install.packages("lsr")
     library(lsr)
     etaSquared(model,type = 2, anova = FALSE)
     

      
 
 
 
 
